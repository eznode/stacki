<stack:stack>

	<stack:copyright>
	Copyright (c) 2006 - 2018 Teradata
	All rights reserved. Stacki(r) v5.x stacki.com
	https://github.com/Teradata/stacki/blob/master/LICENSE.txt
	</stack:copyright>

        <stack:rocks>
        Copyright (c) 2000 - 2010 The Regents of the University of California
        All rights reserved. Rocks(r) v5.4 www.rocksclusters.org
        https://github.com/Teradata/stacki/blob/master/LICENSE-ROCKS.txt
        </stack:rocks>

	<stack:package>stack-sql</stack:package>
	<stack:package>mariadb</stack:package>


<stack:script stack:stage="install-post">

<!--
	set the hostname to the private name. this helps the stacki command
	line find the host 'localhost' correctly
-->
/bin/hostname &hostname;

<stack:file stack:name="/etc/hostname" cond="os == 'sles'">
&Info_FQDN;
</stack:file>

<!--
	Add the stackdb user and group to the system.
	This is the user that will run the Rocks database.
	Also setup the correct directories and their
	permissions for running the database
-->
mkdir -p /var/run/mysql

groupadd -g 403 stackdb
useradd -u 403 -g stackdb -d /var/run/mysql -m -s /bin/false stackdb

chgrp -R stackdb /var/run/mysql
chmod -R g+rwx   /var/run/mysql
chmod a+rx /var/run/mysql

if [ -f /usr/sbin/ldconfig ]
then
	/usr/sbin/ldconfig
elif [ -f /sbin/ldconfig ]
then
	/sbin/ldconfig
fi


<stack:file stack:name="/etc/systemd/system/mysql">

<![CDATA[
[Unit]
Description=MariaDB database server
After=network.target
After=syslog.target
[Install]
WantedBy=multi-user.target
Alias=mysql.service
Alias=mysqld.service
[Service]
Type=notify
PrivateNetwork=false
Environment="MYSQLD_OPTS=--defaults-file=/etc/my.cnf.d/server.cnf --datadir=/var/run/mysql --user=stackdb"
User=stackdb
Group=stackdb
CapabilityBoundingSet=CAP_IPC_LOCK
ProtectSystem=full
PrivateDevices=true
ProtectHome=true
PermissionsStartOnly=true
@SYSTEMD_EXECSTARTPRE@
ExecStartPre=/bin/sh -c "systemctl unset-environment _WSREP_START_POSITION"
ExecStartPre=/bin/sh -c "[ ! -e @bindir@/galera_recovery ] && VAR= || \
 VAR=`@bindir@/galera_recovery`; [ $? -eq 0 ] \
 && systemctl set-environment _WSREP_START_POSITION=$VAR || exit 1"
ExecStart=@sbindir@/mysqld $MYSQLD_OPTS $_WSREP_NEW_CLUSTER $_WSREP_START_POSITION
@SYSTEMD_EXECSTARTPOST@
ExecStartPost=/bin/sh -c "systemctl unset-environment _WSREP_START_POSITION"
KillMode=process
KillSignal=SIGTERM
SendSIGKILL=no
Restart=on-abort
RestartSec=5s
UMask=007
PrivateTmp=false
LimitNOFILE=16364


]]>
</stack:file>


<!-- Generate random password for root access to the database -->
root_pw=`/opt/stack/sbin/gen_random_pw`
<stack:file stack:name="/etc/root.my.cnf" stack:perms="0400"
	    stack:owner="root:root" stack:vars="expanded">
[client]
user		= root
socket		= /var/run/mysql/mysql.sock
password	= $root_pw
</stack:file>

<stack:file stack:name="/etc/my.cnf.d/server.cnf" stack:perms="0400"
	    stack:owner="stackdb:stackdb">
[mysqld]
user		= stackdb
port		= 40000
socket		= /var/run/mysql/mysql.sock
datadir		= /var/run/mysql
max_allowed_packet = 1024M
</stack:file>


<!-- Generate random password for apache access to database -->
apache_pw=`/opt/stack/sbin/gen_random_pw`
<stack:file stack:name="/etc/my.cnf"
	    stack:owner="root:apache" stack:perms="0640" stack:vars="expanded">
[client]
user		= apache
port		= 40000
socket		= /var/run/mysql/mysql.sock
password	= $apache_pw
</stack:file>

<!--
	Setup MariaDB to startup at boot
	and start database
-->
/usr/bin/mysql-install-db

/usr/bin/systemctl enable mysql
/usr/bin/systemctl start mysql

export MYSQLD_OPTS="--defaults-file=/etc/my.cnf.d/server.cnf \
	--datadir=/var/run/mysql \
	--user=stackdb"
<!-- may have to manually start the database -->
/usr/bin/mysqladmin -s ping > /dev/null
if [ $? -ne 0 ] ; then
	nohup /usr/sbin/mysqld ${MYSQLD_OPTS} &gt;&gt; /root/mysqld.log 2&gt;&amp;1 &lt; /dev/null &amp;
fi

<!--
	Make sure that the database is
	up and running
-->
/usr/bin/mysqladmin -s ping > /dev/null
while [ $? -ne 0 ]; do
        sleep 1
        /usr/bin/mysqladmin -s ping > /dev/null
done
</stack:script>

<!-- Access control on the database -->
<stack:script stack:stage="install-post" stack:shell="/opt/stack/bin/python3">
import os
import sys
import re
import string
import base64

import pymysql

def get_pass_from_conf(f):
	passwd = None
	conf_file = open(f, 'r')
	for line in conf_file.readlines():
		if line.startswith('password'):
			passwd = line.split('=')[1].strip()
			break
	conf_file.close()
	return passwd
	
# Connect to the database
d = pymysql.connect(user='root', db='mysql', passwd='',
	unix_socket='/var/run/mysql/mysql.sock',
	autocommit=True)

try:
	db = d.cursor()
except:
	sys.exit(-1)

# Read the root database password from root.my.cnf
root_pass = get_pass_from_conf('/etc/root.my.cnf')
cmd_set = []

# Password Access for root
cmd_set.append('set password for "root"@"localhost"=PASSWORD("%s")' % root_pass)
cmd_set.append('set password for "root"@"127.0.0.1"=PASSWORD("%s")' % root_pass)
cmd_set.append('set password for "root"@"&hostname;"=PASSWORD("%s")' % root_pass)

# Read the apache db password from my.cnf
apache_pass = get_pass_from_conf('/etc/my.cnf')

# Password access for apache
cmd_set.append('create user "apache"@"localhost" identified by "%s"' % apache_pass)
cmd_set.append('create user "apache"@"127.0.0.1" identified by "%s"' % apache_pass)
cmd_set.append('create user "apache"@"&hostname;" identified by "%s"' % apache_pass)

for cmd in cmd_set:
	try:
		db.execute(cmd)
	except:
		sys.stderr.write("Could not execute %s\n" % cmd)
</stack:script>
</stack:stack>
